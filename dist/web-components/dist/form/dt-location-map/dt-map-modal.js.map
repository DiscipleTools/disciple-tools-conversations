{"version":3,"file":"dt-map-modal.js","sources":["../../../src/components/form/dt-location-map/dt-map-modal.js"],"sourcesContent":["import { css, html } from 'lit';\nimport { msg } from '@lit/localize';\nimport DtBase from '../../dt-base.js';\nimport '../../layout/dt-modal/dt-modal.js';\n\nexport class DtMapModal extends DtBase {\n  static get properties() {\n    return {\n      ...super.properties,\n      title: { type: String },\n      isOpen: { type: Boolean },\n      canEdit: { type: Boolean, state: true },\n      metadata: { type: Object },\n      center: { type: Array },\n      mapboxToken: {\n        type: String,\n        attribute: 'mapbox-token',\n      },\n    };\n  }\n\n  static get styles() {\n    return [\n      css`\n        .map {\n          width: 100%;\n          min-width: 50vw;\n          min-height: 50dvb;\n        }\n      `,\n    ];\n  }\n\n  constructor() {\n    super();\n\n    this.addEventListener('open', (e) => {\n      this.shadowRoot.querySelector('dt-modal').dispatchEvent(new Event('open'));\n      this.isOpen = true;\n    });\n    this.addEventListener('close', (e) => {\n      this.shadowRoot.querySelector('dt-modal').dispatchEvent(new Event('close'));\n      this.isOpen = false;\n    });\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n\n    this.canEdit = !this.metadata;\n\n    if (!window.mapboxgl) {\n      let script = document.createElement('script');\n      script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js';\n      script.onload = this.initMap.bind(this);\n      document.body.appendChild(script);\n      console.log('injected script')\n    } else {\n      this.initMap();\n    }\n  }\n\n  initMap() {\n    if (!this.isOpen || !window.mapboxgl || !this.mapboxToken) {\n      return;\n    }\n\n    const mapContainer = this.shadowRoot.querySelector('#map')\n    if (mapContainer && !this.map) {\n      this.map = new window.mapboxgl.Map({\n        accessToken: this.mapboxToken,\n        container: mapContainer,\n        style: 'mapbox://styles/mapbox/streets-v12', // style URL\n        minZoom: 1,\n      });\n      this.map.on('load', () => this.map.resize());\n      if (this.center && this.center.length) {\n        this.map.setCenter(this.center);\n        this.map.setZoom(15);\n      }\n\n      // Add zoom controls\n      const nav = new mapboxgl.NavigationControl();\n      this.map.addControl(nav, 'bottom-right');\n\n      // Add pin if there is one\n      this.addPinFromMetadata();\n\n      // If map is editable add/move marker on click\n      this.map.on('click', (e) => {\n        if (!this.canEdit) {\n          return;\n        }\n        if (this.marker) {\n          this.marker.setLngLat(e.lngLat)\n        } else {\n          this.marker = new mapboxgl.Marker()\n            .setLngLat(e.lngLat)\n            .addTo(this.map);\n        }\n      });\n    }\n  }\n\n  addPinFromMetadata() {\n    if (this.metadata) {\n      const { lng, lat, level } = this.metadata;\n      let zoom = 15\n      if ('admin0' === level) {\n        zoom = 3\n      } else if ('admin1' === level) {\n        zoom = 6\n      } else if ('admin2' === level) {\n        zoom = 10\n      }\n\n      if (this.map) {\n        this.map.setCenter([lng, lat]);\n        this.map.setZoom(zoom);\n        this.marker = new mapboxgl.Marker()\n          .setLngLat([lng, lat])\n          .addTo(this.map);\n      }\n    }\n  }\n\n  updated(changedProperties) {\n    if (!window.mapboxgl) {\n      return;\n    }\n\n    if (changedProperties.has('metadata') && this.metadata && this.metadata.lat) {\n      this.addPinFromMetadata()\n    }\n    if (changedProperties.has('isOpen') && this.isOpen) {\n      this.initMap();\n    }\n  }\n\n  onClose(e) {\n    if (e?.detail?.action === 'button' && this.marker) {\n      this.dispatchEvent(new CustomEvent('submit', {\n        detail: {\n          location: this.marker.getLngLat(),\n        }\n      }));\n    }\n  }\n  render() {\n    return html`      \n      <dt-modal\n        .title=${this.metadata?.label}\n        ?isopen=${this.isOpen}\n        hideButton\n        @close=${this.onClose}\n      >\n        <div slot=\"content\">\n          <div class=\"map\" id=\"map\"></div>\n        </div>\n       \n        ${this.canEdit ? html`<div slot=\"close-button\">${msg('Save')}</div>` : null}\n      </dt-modal>\n      \n      <link href='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />\n    `;\n  }\n}\n\nwindow.customElements.define('dt-map-modal', DtMapModal);\n"],"names":["window","customElements","define","DtBase","properties","super","title","type","String","isOpen","Boolean","canEdit","state","metadata","Object","center","Array","mapboxToken","attribute","styles","css","constructor","this","addEventListener","e","shadowRoot","querySelector","dispatchEvent","Event","connectedCallback","mapboxgl","initMap","script","document","createElement","src","onload","bind","body","appendChild","console","log","mapContainer","map","Map","accessToken","container","style","minZoom","on","resize","length","setCenter","setZoom","nav","NavigationControl","addControl","addPinFromMetadata","marker","setLngLat","lngLat","Marker","addTo","lng","lat","level","zoom","updated","changedProperties","has","onClose","detail","action","CustomEvent","location","getLngLat","render","html","label","msg"],"mappings":"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"}