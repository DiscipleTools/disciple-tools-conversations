{"version":3,"file":"dt-location-map.js","sources":["../../../src/components/form/dt-location-map/dt-location-map.js"],"sourcesContent":["import { css, html } from 'lit';\nimport { repeat } from 'lit/directives/repeat.js';\nimport DtFormBase from '../dt-form-base.js';\nimport './dt-location-map-item.js';\n\nexport class DtLocationMap extends DtFormBase {\n  static get properties() {\n    return {\n      ...super.properties,\n      placeholder: { type: String },\n      value: {\n        type: Array,\n        reflect: true,\n      },\n      locations: {\n        type: Array,\n        state: true,\n      },\n      open: {\n        type: Boolean,\n        state: true,\n      },\n      onchange: { type: String },\n      mapboxToken: {\n        type: String,\n        attribute: 'mapbox-token',\n      },\n      googleToken: {\n        type: String,\n        attribute: 'google-token',\n      },\n    };\n  }\n\n  static get styles() {\n    return [\n      ...super.styles,\n      css`\n        :host {\n          font-family: Helvetica, Arial, sans-serif;\n        }\n        .input-group {\n          display: flex;\n        }\n\n        .field-container {\n          position: relative;\n        }\n      `,\n    ];\n  }\n\n  constructor() {\n    super();\n    this.value = [];\n    this.locations = [{\n      id: Date.now(),\n    }];\n  }\n\n  _setFormValue(value) {\n    super._setFormValue(value);\n    this.internals.setFormValue(JSON.stringify(value));\n  }\n\n  willUpdate(...args) {\n    super.willUpdate(...args);\n\n    if (this.value) {\n      if (this.value.filter((opt) => !opt.id)) {\n        this.value = [\n          ...this.value.map((opt) => ({\n            ...opt,\n            id: opt.grid_meta_id,\n          }))\n        ];\n      }\n    }\n    this.updateLocationList();\n  }\n\n  firstUpdated(...args) {\n    super.firstUpdated(...args);\n    this.internals.setFormValue(JSON.stringify(this.value));\n  }\n\n  updated(changedProperties) {\n    // if length of value was changed, focus the last element\n    if (changedProperties.has('value')) {\n      const old = changedProperties.get('value');\n      if (old && old?.length !== this.value?.length) {\n        this.focusNewLocation();\n      }\n    }\n    // if length of locations was changed, focus the last element\n    if (changedProperties.has('locations')) {\n      const old = changedProperties.get('locations');\n      if (old && old?.length !== this.locations?.length) {\n        this.focusNewLocation();\n      }\n    }\n  }\n\n  focusNewLocation() {\n    const items = this.shadowRoot.querySelectorAll('dt-location-map-item');\n    if (items && items.length) {\n      // console.log('trigger focus');\n      items[items.length - 1].dispatchEvent(new Event('autofocus'));\n    }\n  }\n\n  updateLocationList() {\n    if (!this.disabled && (this.open || !this.value || !this.value.length)) {\n      this.open = true;\n      this.locations = [\n        ...(this.value || []).filter(i => i.label),\n        {\n          id: Date.now(),\n        }\n      ];\n    } else {\n      this.locations = [\n        ...(this.value || []).filter(i => i.label),\n      ];\n    }\n  }\n\n  selectLocation(evt) {\n    const event = new CustomEvent('change', {\n      detail: {\n        field: this.name,\n        oldValue: this.value,\n      },\n    });\n    const newLocation = {\n      ...evt.detail.metadata,\n      id: Date.now(),\n    }\n    this.value = [\n      ...(this.value || []).filter(i => i.label),\n      newLocation,\n    ];\n    this.updateLocationList();\n    event.detail.newValue = this.value;\n\n    // dispatch event for use with addEventListener from javascript\n    this.dispatchEvent(event);\n    this._setFormValue(this.value);\n  }\n\n  deleteItem(evt) {\n    const event = new CustomEvent('change', {\n      detail: {\n        field: this.name,\n        oldValue: this.value,\n      },\n    });\n\n    const item = evt.detail?.metadata;\n    const gridMetaId = item?.grid_meta_id;\n    if (gridMetaId) {\n      // remove this item from the value\n      this.value = (this.value || []).filter(m => m.grid_meta_id !== gridMetaId);\n    } else {\n      // remove by lat/lng\n      this.value = (this.value || []).filter(m => m.lat !== item.lat && m.lng !== item.lng);\n    }\n\n    this.updateLocationList();\n    event.detail.newValue = this.value;\n\n    // dispatch event for use with addEventListener from javascript\n    this.dispatchEvent(event);\n    this._setFormValue(this.value);\n  }\n\n  addNew() {\n    this.open = true;\n    this.updateLocationList();\n  }\n\n  renderItem(opt) {\n    return html`\n      <dt-location-map-item\n        placeholder=\"${this.placeholder}\"\n        .metadata=${opt}\n        mapbox-token=\"${this.mapboxToken}\"\n        google-token=\"${this.googleToken}\"\n        @delete=${this.deleteItem}\n        @select=${this.selectLocation}\n        ?disabled=${this.disabled}\n      ></dt-location-map-item>\n    `;\n  }\n\n  render() {\n    const values = [...(this.value || [])];\n    values.push({\n      id: Date.now(),\n    });\n    return html`\n      ${this.labelTemplate()}\n\n      ${repeat(this.locations || [], (opt) => opt.id, (opt, idx) => this.renderItem(opt, idx))}\n      ${!this.open\n        ? html`<button @click=\"${this.addNew}\">Add New</button>`\n        : null}\n    `;\n  }\n}\n\nwindow.customElements.define('dt-location-map', DtLocationMap);\n"],"names":["window","customElements","define","DtFormBase","properties","super","placeholder","type","String","value","Array","reflect","locations","state","open","Boolean","onchange","mapboxToken","attribute","googleToken","styles","css","constructor","this","id","Date","now","_setFormValue","internals","setFormValue","JSON","stringify","willUpdate","args","filter","opt","map","grid_meta_id","updateLocationList","firstUpdated","updated","changedProperties","has","old","get","length","focusNewLocation","items","shadowRoot","querySelectorAll","dispatchEvent","Event","disabled","i","label","selectLocation","evt","event","CustomEvent","detail","field","name","oldValue","newLocation","metadata","newValue","deleteItem","item","gridMetaId","m","lat","lng","addNew","renderItem","html","render","labelTemplate","repeat","idx"],"mappings":"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"}