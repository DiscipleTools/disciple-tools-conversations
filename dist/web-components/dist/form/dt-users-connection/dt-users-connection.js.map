{"version":3,"file":"dt-users-connection.js","sources":["../../../src/components/form/dt-users-connection/dt-users-connection.js"],"sourcesContent":["import { css, html } from 'lit';\nimport { DtTags } from '../dt-tags/dt-tags.js';\n\nexport class DtUsersConnection extends DtTags {\n  static get styles() {\n    return [\n      ...super.styles,\n      css`\n        .selected-option a {\n          border-inline-start: solid 3px transparent;\n        }\n\n        li button * {\n          pointer-events: none;\n        }\n\n        li {\n          border-inline-start: solid 5px transparent;\n        }\n\n        li button .status {\n          font-style: italic;\n          opacity: 0.6;\n        }\n        li button .status:before {\n          content: '[';\n          font-style: normal;\n        }\n        li button .status:after {\n          content: ']';\n          font-style: normal;\n        }\n\n        li button svg {\n          width: 20px;\n          height: auto;\n          margin-bottom: -4px;\n        }\n        li button svg use {\n          fill: var(--dt-connection-icon-fill, var(--primary-color));\n        }\n      `,\n    ];\n  }\n\n  _clickOption(e) {\n    if (e.target && e.target.value) {\n      const id = parseInt(e.target.value, 10);\n      const option = this.filteredOptions.reduce((result, opt) => {\n        if (!result && opt.id == id) {\n          return opt;\n        }\n        return result;\n      }, null);\n      if (option) {\n        this._select(option);\n      }\n      this._clearSearch();\n    }\n  }\n\n  _clickAddNew(e) {\n    if (e.target) {\n      this._select({\n        id: e.target.dataset?.label,\n        label: e.target.dataset?.label,\n        isNew: true,\n      });\n      // clear search field if clicked with mouse, since field will lose focus\n      const input = this.shadowRoot.querySelector('input');\n      if (input) {\n        input.value = '';\n      }\n    }\n  }\n\n  _keyboardSelectOption() {\n    if (this.activeIndex > -1) {\n      if (this.activeIndex + 1 > this.filteredOptions.length) {\n        this._select({\n          id: this.query,\n          label: this.query,\n          isNew: true,\n        });\n      } else {\n        this._select(this.filteredOptions[this.activeIndex]);\n      }\n      this._clearSearch();\n    }\n  }\n\n  _remove(e) {\n    if (e.target && e.target.dataset && e.target.dataset.value) {\n      const event = new CustomEvent('change', {\n        detail: {\n          field: this.name,\n          oldValue: this.value,\n          remove: true,\n        },\n      });\n      this.value = (this.value || []).map(i => {\n        const val = {\n          ...i,\n        };\n        if (i.id === parseInt(e.target.dataset.value, 10)) {\n          val.delete = true;\n        }\n        return val;\n      });\n      event.detail.newValue = this.value;\n\n      // dispatch event for use with addEventListener from javascript\n      this.dispatchEvent(event);\n\n      // If option was de-selected while list was open, re-focus input\n      if (this.open) {\n        this.shadowRoot.querySelector('input').focus();\n      }\n    }\n  }\n\n  /**\n   * Filter to options that:\n   *   1: are not selected\n   *   2: match the search query\n   * @private\n   */\n  _filterOptions() {\n    const selectedValues = (this.value || [])\n      .filter(i => !i.delete)\n      .map(v => v?.id);\n\n    if (this.options?.length) {\n      this.filteredOptions = (this.options || []).filter(\n        opt =>\n          !selectedValues.includes(opt.id) &&\n          (!this.query ||\n            opt.label\n              .toLocaleLowerCase()\n              .includes(this.query.toLocaleLowerCase()))\n      );\n    } else if (this.open || this.canUpdate) {\n      // Only run this filtering if the list is open.\n      // This prevents it from running on initial load before a `load` event is attached.\n      this.loading = true;\n      this.filteredOptions = [];\n\n      // need to fetch data via API request\n      const self = this;\n      const event = new CustomEvent('dt:get-data', {\n        bubbles: true,\n        detail: {\n          field: this.name,\n          postType: this.postType,\n          query: this.query,\n          onSuccess: result => {\n            self.loading = false;\n\n            // filter out selected values from list\n            self.filteredOptions = result.filter(\n              opt => !selectedValues.includes(opt.id)\n            );\n          },\n          onError: error => {\n            console.warn(error);\n            self.loading = false;\n            this.canUpdate = false;\n          },\n        },\n      });\n      this.dispatchEvent(event);\n    }\n    return this.filteredOptions;\n  }\n\n  _renderSelectedOptions() {\n    return (this.value || [])\n      .filter(i => !i.delete)\n      .map(\n        opt => html`\n          <div class=\"selected-option\">\n            <a\n              href=\"${opt.link}\"\n              style=\"border-inline-start-color: ${opt.status\n                ? opt.status\n                : ''}\"\n              ?disabled=\"${this.disabled}\"\n              title=\"${opt.label}\"\n              >${opt.label}</a\n            >\n            <button\n              @click=\"${this._remove}\"\n              ?disabled=\"${this.disabled}\"\n              data-value=\"${opt.id}\"\n            >\n              x\n            </button>\n          </div>\n        `\n      );\n  }\n\n  _renderOption(opt, idx) {\n    return html`\n      <li tabindex=\"-1\" style=\"border-inline-start-color:${opt.status}\">\n        <button\n          value=\"${opt.id}\"\n          type=\"button\"\n          data-label=\"${opt.label}\"\n          @click=\"${this._clickOption}\"\n          @touchstart=\"${this._touchStart}\"\n          @blur=\"${this._inputFocusOut}\"\n          @touchmove=\"${this._touchMove}\"\n          @touchend=\"${this._touchEnd}\"\n          tabindex=\"-1\"\n          class=\"${this.activeIndex > -1 && this.activeIndex === idx\n            ? 'active'\n            : ''}\"\n        >\n          <span class=\"avatar\"><img src=\"${opt.avatar}\" alt=\"${opt.label}\"/></span> &nbsp;\n          <span class=\"connection-id\">${opt.label}</span>\n        </button>\n      </li>\n    `;\n  }\n}\n\nwindow.customElements.define('dt-users-connection', DtUsersConnection);\n"],"names":["window","customElements","define","DtTags","styles","super","css","_clickOption","e","target","value","id","parseInt","option","this","filteredOptions","reduce","result","opt","_select","_clearSearch","_clickAddNew","dataset","label","isNew","input","shadowRoot","querySelector","_keyboardSelectOption","activeIndex","length","query","_remove","event","CustomEvent","detail","field","name","oldValue","remove","map","i","val","delete","newValue","dispatchEvent","open","focus","_filterOptions","selectedValues","filter","v","options","includes","toLocaleLowerCase","canUpdate","loading","self","bubbles","postType","onSuccess","onError","error","console","warn","_renderSelectedOptions","html","link","status","disabled","_renderOption","idx","_touchStart","_inputFocusOut","_touchMove","_touchEnd","avatar"],"mappings":"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"}