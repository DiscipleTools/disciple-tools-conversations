{"version":3,"file":"hasOptionsList.js","sources":["../../../src/components/form/mixins/hasOptionsList.js"],"sourcesContent":["import { html } from 'lit';\nimport { msg } from '@lit/localize';\n\nexport const HasOptionsList = (superClass) => class extends superClass {\n  constructor() {\n    super();\n    this.activeIndex = -1;\n    this.filteredOptions = [];\n    this.detectTap = false;\n  }\n\n  static get properties() {\n    return {\n      ...super.properties,\n      value: {\n        type: Array,\n        reflect: true,\n      },\n      query: {\n        type: String,\n        state: true,\n      },\n      options: { type: Array },\n      filteredOptions: { type: Array, state: true },\n      open: {\n        type: Boolean,\n        state: true,\n      },\n      canUpdate:{\n        type:Boolean,\n        state: true\n      },\n      activeIndex: {\n        type: Number,\n        state: true,\n      },\n      containerHeight: {\n        type: Number,\n        state: true,\n      },\n      loading: { type: Boolean },\n    };\n  }\n\n  willUpdate(props) {\n    super.willUpdate(props);\n\n    if (props) {\n      // Set the containerHeight for dropdown positioning if it hasn't been set yet\n      if (\n        !this.containerHeight &&\n        this.shadowRoot.children &&\n        this.shadowRoot.children.length\n      ) {\n        const inputGroup = this.shadowRoot.querySelector('.input-group');\n        if (inputGroup) {\n          this.containerHeight = inputGroup.offsetHeight;\n        }\n      }\n    }\n  }\n\n  updated() {\n    this._scrollOptionListToActive();\n\n    // set variable with width of container for truncating selected options via CSS\n    const container = this.shadowRoot.querySelector('.input-group');\n    const currentValue = container.style.getPropertyValue('--container-width');\n    if (!currentValue && container.clientWidth > 0) {\n      container.style.setProperty(\n        '--container-width',\n        `${container.clientWidth}px`\n      );\n    }\n  }\n\n  _select() { // eslint-disable-line class-methods-use-this\n    console.error(\"Must implement `_select(value)` function\");\n  }\n\n  /* Search Input Field Events */\n  static _focusInput(e) {\n    if (e.target !== e.currentTarget) return;\n\n    e.target.getElementsByTagName('input')[0].focus();\n  }\n\n  _inputFocusIn(e) {\n    if (\n      !e.relatedTarget ||\n      !['BUTTON', 'LI'].includes(e.relatedTarget.nodeName)\n    ) {\n      this.open = true;\n      this.activeIndex = -1;\n    }\n  }\n\n  _inputFocusOut(e) {\n    // allow clicks on option list button to not close the option list\n    // Safari actually passes the parent <li> as the relatedTarget\n    if (\n      !e.relatedTarget ||\n      !['BUTTON', 'LI'].includes(e.relatedTarget.nodeName)\n    ) {\n      this.open = false;\n      this.canUpdate = true;\n    }\n  }\n\n  _inputKeyDown(e) {\n    const keycode = e.keyCode || e.which;\n\n    switch (keycode) {\n      case 8: // backspace\n        if (e.target.value === '') {\n          this.value = this.value.slice(0, -1);\n        } else {\n          this.open = true;\n        }\n        break;\n      case 38: // arrow up\n        this.open = true;\n        this._listHighlightPrevious();\n        break;\n      case 40: // arrow down\n        this.open = true;\n        this._listHighlightNext();\n        break;\n      case 9: // tab\n        if (this.activeIndex < 0) {\n          // if pressing tab while no option is selected,\n          // close the list so you can go to next field\n          this.open = false;\n        } else {\n          e.preventDefault();\n        }\n        this._keyboardSelectOption();\n        break;\n      case 13: // enter\n        this._keyboardSelectOption();\n        break;\n      case 27: // escape\n        this.open = false;\n        this.activeIndex = -1;\n        break;\n      default:\n        this.open = true;\n        break;\n    }\n  }\n\n  _inputKeyUp(e) {\n    this.query = e.target.value;\n  }\n\n  /**\n   * When navigating via keyboard, keep active element within visible area of option list\n   * @private\n   */\n  _scrollOptionListToActive() {\n    const optionList = this.shadowRoot.querySelector('.option-list');\n    const activeEl = this.shadowRoot.querySelector('button.active');\n    if (optionList && activeEl) {\n      const elTop = activeEl.offsetTop;\n      const elBottom = activeEl.offsetTop + activeEl.clientHeight;\n      const listTop = optionList.scrollTop;\n      const listBottom = optionList.scrollTop + optionList.clientHeight;\n      if (elBottom > listBottom) {\n        // active element below visible area. scroll down\n        optionList.scrollTo({\n          top: elBottom - optionList.clientHeight,\n          behavior: 'smooth',\n        });\n      } else if (elTop < listTop) {\n        // active element above visible area. scroll up\n        optionList.scrollTo({ top: elTop, behavior: 'smooth' });\n      }\n    }\n  }\n\n  /* Option List Events */\n  _touchStart(e) {\n    if (e.target) {\n      this.detectTap = false;\n    }\n  }\n\n  _touchMove(e) {\n    if (e.target) {\n      this.detectTap = true;\n    }\n  }\n\n  _touchEnd(e) {\n    if (!this.detectTap) {\n      if (e.target && e.target.value) {\n        this._clickOption(e);\n      }\n      this.detectTap = false;\n    }\n  }\n\n  _keyboardSelectOption() {\n    if (this.activeIndex > -1) {\n      if (this.activeIndex + 1 > this.filteredOptions.length) {\n        this._select(this.query);\n      } else {\n        this._select(this.filteredOptions[this.activeIndex].id);\n      }\n      this._clearSearch();\n    }\n  }\n\n  _clickOption(e) {\n    if (e.target && e.target.value) {\n      this._select(e.target.value);\n      this._clearSearch();\n    }\n  }\n\n  _clickAddNew(e) {\n    if (e.target) {\n      this._select(e.target.dataset?.label);\n      // clear search field if clicked with mouse, since field will lose focus\n      this._clearSearch();\n    }\n  }\n\n  _clearSearch()  {\n    const input = this.shadowRoot.querySelector('input');\n      if (input) {\n        input.value = '';\n      }\n  }\n\n  /* Option List Navigation */\n  _listHighlightNext() {\n    if (this.allowAdd) {\n      this.activeIndex = Math.min(\n        this.filteredOptions.length, // allow 1 more than the list length\n        this.activeIndex + 1\n      );\n    } else {\n      this.activeIndex = Math.min(\n        this.filteredOptions.length - 1,\n        this.activeIndex + 1\n      );\n    }\n  }\n\n  _listHighlightPrevious() {\n    this.activeIndex = Math.max(0, this.activeIndex - 1);\n  }\n\n  /* Rendering */\n  _renderOption(opt, idx) {\n    return html`\n      <li tabindex=\"-1\">\n        <button\n          value=\"${opt.id}\"\n          type=\"button\"\n          data-label=\"${opt.label}\"\n          @click=\"${this._clickOption}\"\n          @touchstart=\"${this._touchStart}\"\n          @touchmove=\"${this._touchMove}\"\n          @touchend=\"${this._touchEnd}\"\n          tabindex=\"-1\"\n          class=\"${this.activeIndex > -1 && this.activeIndex === idx\n      ? 'active'\n      : ''}\"\n        >\n          ${opt.label}\n        </button>\n      </li>\n    `;\n  }\n\n  _baseRenderOptions() {\n    if (!this.filteredOptions.length) {\n      if (this.loading) {\n        return html`<li><div>${msg('Loading options...')}</div></li>`;\n      }\n      return html`<li><div>${msg('No Data Available')}</div></li>`;\n    }\n\n    return this.filteredOptions.map((opt, idx) => this._renderOption(opt, idx));\n  }\n\n  _renderOptions() {\n    let optionsMarkup = this._baseRenderOptions();\n\n    if (this.allowAdd && this.query) {\n      if (!Array.isArray(optionsMarkup)) {\n        optionsMarkup = [optionsMarkup];\n      }\n      optionsMarkup.push(html`<li tabindex=\"-1\">\n        <button\n          data-label=\"${this.query}\"\n          @click=\"${this._clickAddNew}\"\n          @touchstart=\"${this._touchStart}\"\n          @touchmove=\"${this._touchMove}\"\n          @touchend=\"${this._touchEnd}\"\n          class=\"${this.activeIndex > -1 &&\n      this.activeIndex >= this.filteredOptions.length\n        ? 'active'\n        : ''}\"\n        >\n          ${msg('Add')} \"${this.query}\"\n        </button>\n      </li>`);\n    }\n    return optionsMarkup;\n  }\n}\n"],"names":["HasOptionsList","superClass","constructor","super","this","activeIndex","filteredOptions","detectTap","properties","value","type","Array","reflect","query","String","state","options","open","Boolean","canUpdate","Number","containerHeight","loading","willUpdate","props","shadowRoot","children","length","inputGroup","querySelector","offsetHeight","updated","_scrollOptionListToActive","container","style","getPropertyValue","clientWidth","setProperty","_select","console","error","static","e","target","currentTarget","getElementsByTagName","focus","_inputFocusIn","relatedTarget","includes","nodeName","_inputFocusOut","_inputKeyDown","keyCode","which","slice","_listHighlightPrevious","_listHighlightNext","preventDefault","_keyboardSelectOption","_inputKeyUp","optionList","activeEl","elTop","offsetTop","elBottom","clientHeight","listTop","scrollTop","scrollTo","top","behavior","_touchStart","_touchMove","_touchEnd","_clickOption","id","_clearSearch","_clickAddNew","dataset","label","input","allowAdd","Math","min","max","_renderOption","opt","idx","html","_baseRenderOptions","map","msg","_renderOptions","optionsMarkup","isArray","push"],"mappings":"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"}